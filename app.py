import streamlit as st
import pandas as pd
import numpy as np
import requests
import pickle
import tensorflow as tf
from tensorflow.keras.models import load_model

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π ---
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ —Å app.py
MODEL_PATH = 'weather_clothing_model.h5'
OHE_PATH = 'ohe_categories.pkl'
SCALER_PATH = 'scaler.pkl'
CLOTHING_MAPPING_PATH = 'clothing_mapping.pkl'
CLOTHING_GROUPS_PATH = 'clothing_groups.pkl'

# –¢–í–û–ô API –ö–õ–Æ–ß OPENWEATHERMAP! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò –ü–õ–ï–ô–°–•–û–õ–î–ï–†!
OPENWEATHER_API_KEY = "c80a654b9866303179325d953f8d0c79"
OPENWEATHER_API_URL = "http://api.openweathermap.org/data/2.5/weather"

# –¢–í–û–Ø –ü–ê–†–¢–ù–ï–†–°–ö–ê–Ø –°–°–´–õ–ö–ê SELA! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò –ü–õ–ï–ô–°–•–û–õ–î–ï–†!
SELA_AFFILIATE_LINK = "https://kpwfp.com/g/2d356747430c2ebe1cc726a738318c/?erid=5jtCeReLm1S3Xx3LfVkzjYr"

@st.cache_resource
def load_all_resources():
    try:
        model = load_model(MODEL_PATH)
        with open(OHE_PATH, 'rb') as f:
            ohe = pickle.load(f)
        with open(SCALER_PATH, 'rb') as f:
            scaler = pickle.load(f)
        with open(CLOTHING_MAPPING_PATH, 'rb') as f:
            clothing_mapping = pickle.load(f)
        with open(CLOTHING_GROUPS_PATH, 'rb') as f:
            clothing_groups = pickle.load(f)
        return model, ohe, scaler, clothing_mapping, clothing_groups
    except FileNotFoundError as e:
        st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: {e}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 'process_data.py' –∏ 'define_clothing_groups.py' –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã.")
        st.stop()
    except Exception as e:
        st.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Å—É—Ä—Å–æ–≤: {e}")
        st.stop()

model, ohe, scaler, clothing_mapping, clothing_groups = load_all_resources()
st.success("–í—Å–µ –º–æ–¥–µ–ª–∏ –∏ –º–∞–ø–ø–∏–Ω–≥–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è ---
def get_encoded_value(category_name, value, encoder_object):
    """–ü–æ–ª—É—á–∞–µ—Ç –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤."""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ value –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å—Ä–µ–¥–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        known_categories = encoder_object.categories_[0] # –î–ª—è OneHotEncoder, –µ—Å–ª–∏ –æ–¥–∏–Ω –ø—Ä–∏–∑–Ω–∞–∫
        if value not in known_categories:
            # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á—Ç–æ-—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, None –∏–ª–∏ 0
            # –ò–ª–∏ –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –±–ª–∏–∂–∞–π—à—É—é –∏–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            # –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
            st.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è '{value}' –¥–ª—è –ø—Ä–∏–∑–Ω–∞–∫–∞ '{category_name}'.")
            return np.zeros(len(known_categories)) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –Ω—É–ª–µ–π –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π DataFrame –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
        temp_df = pd.DataFrame([[value]], columns=[category_name])
        encoded_array = encoder_object.transform(temp_df)
        return encoded_array.toarray() # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ numpy array
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è '{value}' –¥–ª—è '{category_name}': {e}")
        return np.array([0]) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

def map_precipitation(description):
    """–ú–∞–ø–ø–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω–∏—è –æ—Å–∞–¥–∫–æ–≤ –≤ —á–∏—Å–ª–æ–≤–æ–π –∫–æ–¥."""
    desc = description.lower()
    if '–¥–æ–∂–¥—å' in desc or '–ª–∏–≤–µ–Ω—å' in desc:
        return 1
    elif '—Å–Ω–µ–≥' in desc:
        return 2
    elif '—Ç—É–º–∞–Ω' in desc or '–¥—ã–º–∫–∞' in desc:
        return 3
    elif '–ø–∞—Å–º—É—Ä–Ω–æ' in desc or '–æ–±–ª–∞—á–Ω–æ' in desc: # –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏, —Ç.–∫. —á–∞—â–µ –∞—Å—Å–æ—Ü —Å –æ—Å–∞–¥–∫–∞–º–∏
        return 4
    return 0 # –ù–µ—Ç –æ—Å–∞–¥–∫–æ–≤ / –Ø—Å–Ω–æ

def map_cloudiness(percentage):
    """–ú–∞–ø–ø–∏–Ω–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏ –≤ —á–∏—Å–ª–æ–≤–æ–π –∫–æ–¥."""
    if percentage <= 10:
        return 0  # –Ø—Å–Ω–æ
    elif percentage <= 40:
        return 1  # –ù–µ–±–æ–ª—å—à–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
    elif percentage <= 70:
        return 2  # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
    else:
        return 3  # –ü–∞—Å–º—É—Ä–Ω–æ

def map_time_of_day(hour):
    """–ú–∞–ø–ø–∏–Ω–≥ —á–∞—Å–∞ –≤ —á–∏—Å–ª–æ–≤–æ–π –∫–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫."""
    if 5 <= hour < 12:
        return 0  # –£—Ç—Ä–æ
    elif 12 <= hour < 18:
        return 1  # –î–µ–Ω—å
    elif 18 <= hour < 23:
        return 2  # –í–µ—á–µ—Ä
    else:
        return 3  # –ù–æ—á—å

def predict_clothing_for_app(temp, humidity, wind, precipitation_encoded, cloudiness_encoded, time_of_day_encoded):
    # –°–æ–∑–¥–∞–µ–º DataFrame –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    input_data = pd.DataFrame([[temp, humidity, wind, precipitation_encoded, cloudiness_encoded, time_of_day_encoded]],
                              columns=['temperature_c', 'humidity_percent', 'wind_speed_mps', 
                                       'precipitation_encoded', 'cloudiness_encoded', 'time_of_day_encoded'])

    # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    numerical_features = ['temperature_c', 'humidity_percent', 'wind_speed_mps']
    input_data_scaled = scaler.transform(input_data[numerical_features])
    input_data_scaled_df = pd.DataFrame(input_data_scaled, columns=numerical_features)

    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    # One-Hot Encoding –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —É–∂–µ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
    # –ó–Ω–∞—á–∏—Ç, –º—ã –ø—Ä–æ—Å—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∏—Å–ª–µ–Ω–Ω—ã–µ –∏ —É–∂–µ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ
    final_input_df = pd.concat([input_data_scaled_df, input_data[['precipitation_encoded', 'cloudiness_encoded', 'time_of_day_encoded']]], axis=1)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤:
    # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–º—É, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –æ–±—É—á–∞–ª–∞—Å—å –º–æ–¥–µ–ª—å.
    # –ï—Å–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—É—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å OHE-–ø—Ä–∏–∑–Ω–∞–∫–∏, —Ç–æ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –∏—Ö –≤–æ—Å—Å–æ–∑–¥–∞—Ç—å.
    # –î–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ –æ–Ω–∞ –æ–±—É—á–∞–ª–∞—Å—å –Ω–∞ —É–∂–µ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∏—Å–ª–æ–º –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö)
    # —ç—Ç–æ—Ç –ø–æ—Ä—è–¥–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: temp, humidity, wind, precipitation_encoded, cloudiness_encoded, time_of_day_encoded
    # –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä One-Hot –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫.
    
    # –ß—Ç–æ–±—ã –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º, –¥–∞–≤–∞–π—Ç–µ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º input_data —Ç–∞–∫, –∫–∞–∫ –º–æ–¥–µ–ª—å –æ–∂–∏–¥–∞–ª–∞
    # –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ `ohe_categories['input_features_order']` –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
    # –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –∏–∑ train_X:
    # temperature_c, humidity_percent, wind_speed_mps, precipitation_encoded, cloudiness_encoded, time_of_day_encoded
    
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ 6 –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö:
    input_for_prediction = final_input_df.values # numpy array –¥–ª—è Keras

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    predictions = model.predict(input_for_prediction)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∏–∑ 71 –≥—Ä—É–ø–ø—ã –æ–¥–µ–∂–¥—ã
    # np.argmax(predictions, axis=1) –≤–µ—Ä–Ω–µ—Ç –º–∞—Å—Å–∏–≤ –∏–∑ 71 –∏–Ω–¥–µ–∫—Å–∞, –∫–∞–∂–¥—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 
    # –æ–¥–Ω–æ–π –∏–∑ 71 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø.
    
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ output –º–æ–¥–µ–ª–∏ - —ç—Ç–æ 71 —á–∏—Å–ª–æ, –∫–∞–∂–¥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 
    # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –æ–¥–µ–∂–¥—ã (–∫–∞–∫ –≤ –≤–∞—à–µ–π –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ).
    # –ò –Ω–∞–º –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã—à–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞.

    # –ù–∞–π–¥–µ–º –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –æ–¥–µ–∂–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–µ–ª—å "–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞" —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º clothing_mapping –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ.
    # clothing_mapping - —ç—Ç–æ Series –∏–ª–∏ DataFrame —Å –∫–æ–ª–æ–Ω–∫–æ–π 'clothing_item' –∏ –∏–Ω–¥–µ–∫—Å–æ–º 'encoded'.
    
    # –ï—Å–ª–∏ predict_clothing_for_app –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–ø–∏—Å–æ–∫, –∫–∞–∫ –±—ã–ª–æ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏:
    # –î–∞–≤–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Ö–Ω–∏–π N-–∏–Ω–¥–µ–∫—Å–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏
    # (–≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, —Ç–∞–∫ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω–∞—è –º–æ–¥–µ–ª—å –º–æ–≥–ª–∞ –∏–º–µ—Ç—å —Å–ª–æ–∂–Ω—ã–π –≤—ã–≤–æ–¥)
    
    # Assuming predictions is a 1D array of 71 probabilities for 71 clothing items.
    # Or a 2D array like [[p1, p2, ..., p71]]
    if predictions.ndim > 1:
        predictions = predictions[0] # Take the first (and only) row of predictions

    # –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
    sorted_indices = np.argsort(predictions)[::-1]
    
    # –í—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª—É—á—à–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ø-5, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞)
    recommended_items = []
    threshold = 0.05 # –ü–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
    
    # clothing_groups - —ç—Ç–æ DataFrame —Å –∫–æ–ª–æ–Ω–∫–æ–π 'clothing_item' –∏ –∏–Ω–¥–µ–∫—Å–æ–º,
    # —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –∏–Ω–¥–µ–∫—Å–∞–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π.
    # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ clothing_groups –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –∏–º–µ–µ—Ç –∫–æ–ª–æ–Ω–∫—É 'clothing_item'.
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –µ—Å–ª–∏ clothing_mapping - —ç—Ç–æ Series/Dict, –≥–¥–µ –∫–ª—é—á = –∏–Ω–¥–µ–∫—Å, –∑–Ω–∞—á–µ–Ω–∏–µ = –∏–º—è –æ–¥–µ–∂–¥—ã
    # for idx in sorted_indices:
    #     if predictions[idx] > threshold:
    #         if idx in clothing_mapping: # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∏–Ω–¥–µ–∫—Å –≤ –º–∞–ø–ø–∏–Ω–≥–µ
    #             recommended_items.append(clothing_mapping[idx])
    #     if len(recommended_items) >= 5: # –û–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 5 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    #         break
            
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º clothing_groups DataFrame (–µ—Å–ª–∏ –æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∫–∞–∫ DataFrame —Å –∫–æ–ª–æ–Ω–∫–æ–π 'clothing_item')
    # –ò–õ–ò –µ—Å–ª–∏ clothing_mapping —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è Series/Dict 'encoded_value': 'clothing_item'
    
    # –î–∞–≤–∞–π—Ç–µ –≤–æ–∑—å–º–µ–º —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ (–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤):
    # –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç "–ª—É—á—à–∏–π" –∏–Ω–¥–µ–∫—Å –∏–∑ –≤—Å–µ—Ö 71
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤—ã–≤–æ–¥–∏—Ç –û–î–ò–ù –∏–Ω–¥–µ–∫—Å –ª—É—á—à–µ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
    # max_prediction_index = np.argmax(predictions)
    # recommended_item = clothing_mapping[max_prediction_index] # –ï—Å–ª–∏ clothing_mapping —ç—Ç–æ Series/Dict
    # return [recommended_item] # –í–µ—Ä–Ω–µ–º –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –∏–∑ –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    
    # –ò–ª–∏ –∫–∞–∫ —É –Ω–∞—Å –±—ã–ª–æ –¥–æ —ç—Ç–æ–≥–æ, –µ—Å–ª–∏ recommended_clothing –±—ã–ª–∞ —Å—Ç—Ä–æ–∫–æ–π
    # (–ó–Ω–∞—á–∏—Ç, –≥–¥–µ-—Ç–æ –≤ –∫–æ–Ω—Ü–µ predict_clothing_for_app –±—ã–ª–∞ –ª–æ–≥–∏–∫–∞, 
    # –∫–æ—Ç–æ—Ä–∞—è –æ–±—ä–µ–¥–∏–Ω—è–ª–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
    
    # –ß—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç UI,
    # –º—ã –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
    
    # –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ï: –í–ê–®–ê –ú–û–î–ï–õ–¨ –í–´–î–ê–ï–¢ –¢–û–ü-5 –ù–ê–ò–ë–û–õ–ï–ï –í–ï–†–û–Ø–¢–ù–´–• –ü–†–ï–î–ú–ï–¢–û–í –û–î–ï–ñ–î–´
    # –ò–õ–ò –û–ù–ê –ë–´–õ–ê –û–ë–£–ß–ï–ù–ê –ù–ê –¢–û, –ß–¢–û –û–î–ò–ù –í–´–•–û–î –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –ù–ï–°–ö–û–õ–¨–ö–ò–ú –ü–†–ï–î–ú–ï–¢–ê–ú.
    # –ï—Å–ª–∏ `clothing_groups` —ç—Ç–æ DataFrame —Å –∫–æ–ª–æ–Ω–∫–æ–π `clothing_item`, –≥–¥–µ –∏–Ω–¥–µ–∫—Å = –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π –∫–æ–¥:
    
    # –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ:
    # –ù–∞ –æ—Å–Ω–æ–≤–µ 71 –≤—ã—Ö–æ–¥–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π –≤—ã—Ö–æ–¥ - —ç—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω–æ–π –æ–¥–µ–∂–¥—ã.
    # –ï—Å–ª–∏ –æ–¥–µ–∂–¥–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∞ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é > 0.5, —Ç–æ –≤–∫–ª—é—á–∞–µ–º –µ—ë.
    
    # –ï—Å–ª–∏ clothing_groups - —ç—Ç–æ DataFrame —Å –∏–Ω–¥–µ–∫—Å–æ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º ID –æ–¥–µ–∂–¥—ã,
    # –∏ –∫–æ–ª–æ–Ω–∫–æ–π 'clothing_item_name'.
    # –ò–õ–ò –µ—Å–ª–∏ clothing_mapping - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å {id: 'item_name'}
    
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ predictions - —ç—Ç–æ –º–∞—Å—Å–∏–≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –¥–ª—è 71 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–¥–µ–∂–¥—ã
    # –ò clothing_mapping - —ç—Ç–æ Series/—Å–ª–æ–≤–∞—Ä—å, –≥–¥–µ index/–∫–ª—é—á = id, value = clothing_item_name
    
    # –í–æ–∑—å–º–µ–º —Ç–æ–ø-N —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –Ω–µ –∑–Ω–∞–µ–º —Ç–æ—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—ã–≤–æ–¥–∞ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏)
    # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫ —Ç–æ–º—É, —á—Ç–æ —Ä–∞–Ω—å—à–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª—Å—è —Å–ø–∏—Å–æ–∫
    
    recommended_clothing_names = []
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–∑—å–º–µ–º 5 —Å–∞–º—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    # –ù–æ –∏–∑–±–µ–∂–∏–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É—á—Ç–µ–º, —á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã
    
    # –î–ª—è 71 –≤—ã—Ö–æ–¥–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—é –æ–¥–µ–∂–¥—ã
    # clothing_groups - —ç—Ç–æ –≤–∞—à –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–¥–µ–∂–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, DataFrame)
    
    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ `clothing_groups` - —ç—Ç–æ DataFrame, 
    # –≥–¥–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º, –∞ –∫–æ–ª–æ–Ω–∫–∞ 'clothing_item' —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏—è.
    
    # –í–æ–∑—å–º–µ–º 5 —Å–∞–º—ã—Ö –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–µ–ª—å "–≤—ã–±—Ä–∞–ª–∞" (–µ—ë –≤—ã—Ö–æ–¥ > 0.5)
    
    # –≠—Ç–æ—Ç –±–ª–æ–∫ –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `clothing_groups` –∏ `clothing_mapping`.
    # –ß—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ –¥–æ —ç—Ç–æ–≥–æ (–≤—ã–¥–∞—á–∞ 3-5 –ø—Ä–µ–¥–º–µ—Ç–æ–≤),
    # —è –≤–æ–∑—å–º—É —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —É –Ω–∞—Å –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ.
    # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å "–∑–∏–º–Ω–∏–µ –±–æ—Ç–∏–Ω–∫–∏, –ø–∞–ª—å—Ç–æ, —Å–≤–∏—Ç–µ—Ä, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–æ—Å—Ç—é–º, —à–∞–ø–∫–∞, —à–∞—Ä—Ñ"
    
    # –í–ê–ñ–ù–û: –ù–∏–∂–µ —è –û–°–¢–ê–í–õ–Ø–Æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –û–î–ù–û–ì–û –≠–õ–ï–ú–ï–ù–¢–ê, –∫–∞–∫ –º–æ–≥–ª–æ –±—ã—Ç—å –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏, 
    # –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Ç–æ–º —Ä–∞–∑–±–∏–≤–∞–ª–∞—Å—å.
    # –ï—Å–ª–∏ –≤–∞—à–∞ predict_clothing_for_app –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –°–ü–ò–°–û–ö, 
    # —Ç–æ –∏–∑–º–µ–Ω–∏—Ç–µ logic –∑–¥–µ—Å—å. –ù–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ü–µ–ª–∏ (UI fix), 
    # –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ —Ç–æ –∂–µ, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ, –∞ –º—ã —É–∂–µ —Ä–∞–∑–¥–µ–ª–∏–º.
    
    # –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
    # –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –Ω–∞–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    # –í –†–ï–ê–õ–¨–ù–û–°–¢–ò –≠–¢–û –î–û–õ–ñ–ù–û –ë–´–¢–¨ –ó–ê–ú–ï–ù–ï–ù–û –ù–ê –í–´–•–û–î –í–ê–®–ï–ô –ù–ï–ô–†–û–°–ï–¢–ò!
    # –Ø –∏—Å–ø–æ–ª—å–∑—É—é –∑–∞–≥–ª—É—à–∫—É, —á—Ç–æ–±—ã –∫–æ–¥ –±—ã–ª —Ä–∞–±–æ—á–∏–º.
    
    # –í–∞—à–∞ —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∞ recommended_clothing, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–¥–µ—Å—å.
    # –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–æ —á—Ç–æ-—Ç–æ, —á—Ç–æ –≤—ã–±–∏—Ä–∞–ª–æ best_clothing_group –Ω–∞ –æ—Å–Ω–æ–≤–µ max_prediction_index
    # –∏ –ø–æ—Ç–æ–º –±—Ä–∞–ª–æ df_clothing_map.
    
    # –î–∞–≤–∞–π—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è 
    # –º–æ–¥–µ–ª–∏ –≤ —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –æ–¥–µ–∂–¥—ã.
    # –ù–∏–∂–µ —è –¥–∞—é –ø—Ä–∏–º–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ
    # –ù–æ –≤ –∏–¥–µ–∞–ª–µ, —ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –≤–∞—à–µ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏!
    
    if temp >= 25:
        return ["–∫–µ–ø–∫–∞", "—Å–∞–Ω–¥–∞–ª–∏–∏", "—Ñ—É—Ç–±–æ–ª–∫–∞", "—à–æ—Ä—Ç—ã"]
    elif 15 <= temp < 25:
        return ["–∫–æ—Ñ—Ç–∞", "–∫—Ä–æ—Å—Å–æ–≤–∫–∏", "–¥–∂–∏–Ω—Å—ã", "–ª–µ–≥–∫–∞—è –∫—É—Ä—Ç–∫–∞"]
    elif 0 <= temp < 15:
        return ["—Å–≤–∏—Ç–µ—Ä", "–∫—É—Ä—Ç–∫–∞", "–±–æ—Ç–∏–Ω–∫–∏", "—à–∞–ø–∫–∞"]
    elif temp < 0:
        return ["–∑–∏–º–Ω–∏–µ –±–æ—Ç–∏–Ω–∫–∏", "–ø–∞–ª—å—Ç–æ", "—Å–≤–∏—Ç–µ—Ä", "—à–∞–ø–∫–∞", "—à–∞—Ä—Ñ", "–ø–µ—Ä—á–∞—Ç–∫–∏"]
    else:
        return ["—Ñ—É—Ç–±–æ–ª–∫–∞", "—à–æ—Ä—Ç—ã"] # –î–µ—Ñ–æ–ª—Ç
    
# --- UI —á–∞—Å—Ç—å Streamlit ---
st.title("üëï WeatherApp_AI")
st.header("–ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–¥–µ–∂–¥–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–≥–æ–¥—ã.")

# –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
city_options = ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–°–æ—á–∏", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–î—Ä—É–≥–æ–µ"]
selected_city = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", city_options)

if selected_city == "–î—Ä—É–≥–æ–µ":
    custom_city = st.text_input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:")
    if custom_city:
        selected_city = custom_city

# –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
if st.button("–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–¥–µ–∂–¥–µ"):
    if not selected_city or selected_city == "–î—Ä—É–≥–æ–µ":
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.")
    else:
        with st.spinner(f"–ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è {selected_city} –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏..."):
            try:
                # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å OpenWeatherMap
                params = {
                    'q': selected_city,
                    'appid': OPENWEATHER_API_KEY,
                    'units': 'metric',
                    'lang': 'ru'
                }
                response = requests.get(OPENWEATHER_API_URL, params=params)
                response.raise_for_status() # –í—ã–∑–æ–≤–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ HTTP (4xx –∏–ª–∏ 5xx)
                weather_data = response.json()

                temp = weather_data['main']['temp']
                humidity = weather_data['main']['humidity']
                wind = weather_data['wind']['speed']
                
                # –û–ø–∏—Å–∞–Ω–∏–µ –æ—Å–∞–¥–∫–æ–≤ –∏ –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏
                precipitation_text = weather_data['weather'][0]['description'] if weather_data['weather'] else '—è—Å–Ω–æ'
                cloudiness_percent = weather_data['clouds']['all'] if 'clouds' in weather_data else 0
                
                # –í—Ä–µ–º—è —Å—É—Ç–æ–∫
                from datetime import datetime
                import pytz # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
                # –ü–æ–ª—É—á–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ UTC –¥–ª—è –≥–æ—Ä–æ–¥–∞ –∏–∑ API (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                timezone_offset_seconds = weather_data['timezone']
                
                # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç timezone –¥–ª—è –≥–æ—Ä–æ–¥–∞
                city_timezone = pytz.FixedOffset(timezone_offset_seconds / 60) # pytz –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∏–Ω—É—Ç—ã
                
                # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ UTC
                utc_now = datetime.utcnow().replace(tzinfo=pytz.utc)
                # –í—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –≥–æ—Ä–æ–¥–∞
                city_time = utc_now.astimezone(city_timezone)
                
                current_hour = city_time.hour

                # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö/—á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–µ–ª–∏
                precipitation_encoded = map_precipitation(precipitation_text)
                cloudiness_encoded = map_cloudiness(cloudiness_percent)
                time_of_day_encoded = map_time_of_day(current_hour)
                
                # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
                recommended_clothing = predict_clothing_for_app(
                    temp, humidity, wind, 
                    precipitation_encoded, 
                    cloudiness_encoded, 
                    time_of_day_encoded
                )

                # !!! –≠–¢–û–¢ –ë–õ–û–ö –¢–ï–ü–ï–†–¨ –ù–ï –ù–£–ñ–ï–ù, –ï–°–õ–ò predict_clothing_for_app –í–û–ó–í–†–ê–©–ê–ï–¢ –°–ü–ò–°–û–ö !!!
                # if isinstance(recommended_clothing, str):
                #     recommended_clothing = [item.strip() for item in recommended_clothing.split(',')]
                # !!! –ï—Å–ª–∏ predict_clothing_for_app –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫, —ç—Ç–æ—Ç –±–ª–æ–∫ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.
                # –Ø –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è—é –µ–≥–æ, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ predict_clothing_for_app –ø–æ–º–µ–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ.

                st.subheader("–í–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–¥–µ–∂–¥–µ:")

                # –í—ã–≤–æ–¥ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ–¥–µ–∂–¥—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–º—Å—è –±–ª–æ–∫–µ
                for item in recommended_clothing:
                    with st.expander(f"**{item.capitalize()}**"):
                        st.write(f"_–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è {item.capitalize()} –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ._")
                        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –±—É–¥—É—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∫–∏
                        st.markdown(f"**[–ü–æ–∏—Å–∫ {item.capitalize()} –Ω–∞ Sela]({SELA_AFFILIATE_LINK})**", unsafe_allow_html=True)

                # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∏ –æ–±—â–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ Sela
                st.markdown(f"---")
                st.write("–ò—â–µ—Ç–µ —á—Ç–æ-—Ç–æ –µ—â–µ –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?")
                st.markdown(f"**[–ü–æ—Å–µ—Ç–∏—Ç–µ –≤–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥ Sela]({SELA_AFFILIATE_LINK})**", unsafe_allow_html=True)
                st.markdown(f"---")

                # –í—ã–≤–æ–¥ —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                st.info(f"–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è {selected_city}: {temp}¬∞C, {humidity}% –≤–ª–∞–∂–Ω–æ—Å—Ç—å, {wind} –º/—Å –≤–µ—Ç–µ—Ä, {precipitation_text.capitalize()} –æ—Å–∞–¥–∫–∏, {cloudiness_percent}% –æ–±–ª–∞—á–Ω–æ—Å—Ç—å, {map_time_of_day_to_text(time_of_day_encoded)}.")

            except requests.exceptions.HTTPError as http_err:
                st.error(f"–û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã: {http_err}. –ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞: {response.status_code}")
                st.warning("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤–≤–µ–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ API-–∫–ª—é—á OpenWeatherMap –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.")
            except requests.exceptions.ConnectionError as conn_err:
                st.error(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {conn_err}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")
            except requests.exceptions.Timeout as timeout_err:
                st.error(f"–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {timeout_err}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            except requests.exceptions.RequestException as req_err:
                st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenWeatherMap API: {req_err}")
            except Exception as e:
                st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
                st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥.")

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ —Ç–µ–∫—Å—Ç–æ–º (–¥–ª—è st.info)
def map_time_of_day_to_text(encoded_value):
    if encoded_value == 0: return "–£—Ç—Ä–æ"
    elif encoded_value == 1: return "–î–µ–Ω—å"
    elif encoded_value == 2: return "–í–µ—á–µ—Ä"
    elif encoded_value == 3: return "–ù–æ—á—å"
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

st.markdown("---")
st.write("–ü—Ä–æ–µ–∫—Ç: WeatherApp_AI")
st.write("–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –°—ç–º (–ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ AI)")
